// ==UserScript==
// @name         RT All In One
// @namespace    http://tampermonkey.net/
// @version      1.1.1
// @description  Makes the UBIF RT experience more automated so that you can spend more time doing the repair and less on the paperwork.
// @author       Christopher Sullivan
// @include      https://portal.ubif.net/*
// @require      https://github.com/Ashcall3000/UBREAKIFIX/raw/master/SearchElements.js
// @require      https://github.com/serratus/quaggaJS/raw/master/dist/quagga.min.js
// @downloadURL  https://github.com/Ashcall3000/UBREAKIFIX/raw/master/RTAllInOne.min.user.js
// @updateURL    https://github.com/Ashcall3000/UBREAKIFIX/raw/master/RTAllInOne.min.user.js
// @run-at document-idle
// @grant        none
// ==/UserScript==
var RAN_WORKED=1;var RAN_FAILED=-1;var RAN_WAITING=0;var lead_page_ran=RAN_WAITING;var select_device_ran=RAN_WAITING;var create_workorder_ran=RAN_WAITING;var workorder_ran=RAN_WAITING;(function(){var a=setInterval(function(){if(checkURL('https://portal.ubif.net/store-ops/timeclock')&&!checkExist('#update-button')){createTagAppend(find('.portal-actions'),'button','update-button','btn blue left-icon fastclickable','Update Script','background-color: rgb(38, 156, 216); color: white;');createTag(find('#update-button'),'span','','fa fa-fw fa-refresh');find('#update-button').addEventListener('click',function(){window.open('https://github.com/Ashcall3000/UBREAKIFIX/raw/master/RTAllInOne.user.js')})}if(checkURL('https://portal.ubif.net/pos/aqleads/edit/')){if(lead_page_ran==RAN_WAITING){lead_page_ran=leadPage()}}else{lead_page_ran=RAN_WAITING}if(checkURL('https://portal.ubif.net/pos/device-type-select/lead/')){if(select_device_ran==RAN_WAITING){select_device_ran=selectDevicePage()}}else{select_device_ran=RAN_WAITING}if(checkURL('https://portal.ubif.net/pos/device-repair-select/')){if(create_workorder_ran==RAN_WAITING){create_workorder_ran=createWorkOrderPage();imei='';device_type='';part_button=null}}else{create_workorder_ran=RAN_WAITING}if(checkURL('https://portal.ubif.net/pos/checkout-new/')){if(workorder_ran==RAN_WAITING){workOrderPage();workorder_ran=RAN_WORKED}if(checkExist('#ticket-button')&&checkExist('span.bg-repair-in-progress')){if(find('#ticket-button').innerText=='Generate Ticket'){find('#ticket-button').innerText='Close Ticket'}}}else{Waiter.clearSingle('ticket-button');workorder_ran=RAN_WAITING}},500)}());var iphone_list=['iPhone 12','iPhone 12 Pro','iPhone 12 Mini','iPhone 12 Pro Max','iPhone SE (2nd Gen)','iPhone 11','iPhone 11 Pro','iPhone 11 Pro Max','iPhone XS Max','iPhone XS','iPhone XR','iPhone X','iPhone 8','iPhone 8 Plus','iPhone 7','iPhone 7 Plus','iPhone 6S','iPhone 6S Plus','iPhone 6','iPhone 6 Plus'];var samsung_list=['Samsung Galaxy Note 20','Samsung Galaxy Note 20 Ultra','Samsung Galaxy Note 10','Samsung Galaxy Note 10 Plus','Samsung Galaxy Note 9','Samsung Galaxy Note 8','Samsung Galaxy S20','Samsung Galaxy S20 FE','Samsung Galaxy S20 Ultra','Samsung Galaxy S20 Plus','Samsung Galaxy S20 5G','Samsung Galaxy S10 Plus','Samsung Galaxy S10','Samsung Galaxy S10e','Samsung Galaxy S10 Lite','Samsung Galaxy S10 5G','Samsung Galaxy S9','Samsung Galaxy S9 Plus','Samsung Galaxy S8','Samsung Galaxy S8 Plus','Samsung Galaxy S7','Samsung Galaxy S7 Edge','Samsung Galaxy A71','Samsung Galaxy A70','Samsung Galaxy A51','Samsung Galaxy A50','Samsung Galaxy A21','Samsung Galaxy A20','Samsung Galaxy A11','Samsung Galaxy A10','Samsung Galaxy A10e'];var part_button=null;var imei='';var device_type='';function leadPage(){var a=setInterval(function(){if(findByText('span','Dismiss')){findByText('span','Dismiss').click();clearInterval(a)}if(checkExist('#mobile-table')){clearInterval(a)}},250);if(!checkExist('#mobile-table')&&!findByText('span','Dismiss')){if(checkExist('div.table-hold')){find('div.table-hold').setAttribute('hidden','');find('div.table-hold').id='old-table';createLeadTable();updateLeadTable();return RAN_WORKED}}return RAN_WAITING}function createLeadTable(){var a=find('sale-item-list');var b=createTag(a,'div','mobile-table','table-hold');var c=createTag(b,'table','','table portal-table flatTable table-stripped table-responsive');var d=createTag(c,'tr','','header-row');var e=createTag(d,'th','','center-data');createTag(e,'div','','','Item');d=createTagAppend(c,'tr','','');e=createTag(d,'td','','center-data');createTag(e,'span','item-data','');d=createTagAppend(c,'tr','','header-row');e=createTag(d,'th','','center-data');createTag(e,'div','','','SKU');d=createTagAppend(c,'tr','','');e=createTag(d,'td','','center-data');createTag(e,'span','sku-data','');d=createTagAppend(c,'tr','','header-row');e=createTag(d,'th','','center-data');createTag(e,'div','','','Serial');d=createTagAppend(c,'tr','','');e=createTag(d,'td','','center-data');createTag(e,'span','serial-data','');d=createTagAppend(c,'tr','','header-row');e=createTag(d,'th','','center-data');createTag(e,'div','','','Available');d=createTagAppend(c,'tr','','');e=createTag(d,'td','','center-data');createTag(e,'span','available-data','');d=createTagAppend(c,'tr','','header-row');e=createTag(d,'th','','center-data');createTag(e,'div','','','Remove Part');d=createTagAppend(c,'tr','','');createTag(d,'td','remove-part-td','center-data')}function updateLeadTable(){if(checkExist('div.action-buttons')){if(part_button===null){console.log("running");part_button=find('div.action-buttons');find('#remove-part-td').append(part_button);find('button',part_button).append(document.createTextNode('Remove Part'))}}else{part_button=null}if(findByText('div.device-detail','IMEI')){imei=find('div.details',findByText('div.device-detail','IMEI')).innerText}var a=findByAttribute('td','ng-if','isLeadReserveOrNoReserve() || isReturn()','','',find('#old-table'));if(a!=null){a=a.innerText;find('#sku-data').innerText=a}var b=findSibling('label','div.details','Device').textContent;var c=findByAttribute('td','ng-click','editSaleItem(saleItem, true)','','',find('#old-table'));if(c!=null){c=c.innerText;if(b==''){device_type=getDeviceName(c)}else{device_type=b}find('#item-data').innerText=c}var d=findByAttribute('td','ng-if','!isSaleItemService(saleItem) && hasSaleItemLabel(saleItem)','','',find('#old-table'));if(d){d=d.innerText.substring(6);find('#serial-data').innerText=d}var e=findByAttribute('span','ng-if','!saleItem.inventory.store_item.item.is_service','','',find('#old-table'));if(e!=null){e=e.innerText}if(checkExist('#mobile-table')){if(c){find('#item-data').innerText=c}else{find('#item-data').innerText="Error"}if(a){find('#sku-data').innerText=a}else{find('#sku-data').innerText="Error"}if(e){find('#available-data').innerText=e}else{find('#available-data').innerTExt="Error"}}}function getDeviceName(a){if(a.includes('Samsung')){var b=inArray(a,samsung_list);if(b!=-1){return samsung_list[b]}}else if(a.includes('iPhone')){var b=inArray(a,iphone_list);if(b!=-1){return iphone_list[b]}}return''}function selectDevicePage(){if(!findByText('button','Continue')){if(!checkExist('div.selected')&&device_type!=''){setField('#device-type-searchbox','input',device_type.trim()+' Repair');Waiter.addTable(function(a){console.log('First Table');if(checkExist('div.selected')){Waiter.clearTablesBefore(2)}else{if(!findByText('a','Device not found:')&&find('#device-type-searchbox').value!=''){if(!checkButtonClick(a,device_type.trim()+' Repair','a')){setField('#device-type-searchbox','input',device_type.replace(' Plus','+'))}else{Waiter.clearTablesBefore(2)}}else if(findByText('a','Device not found:')){Waiter.clearTable(a)}}});Waiter.addTable(function(a){console.log('Second Table');if(!findByText('a','Device not found:')&&find('#device-type-searchbox').value!=device_type.replace(' Plus','+')){if(checkButtonClick(a,device_type.replace(' Plus','+'),'a')){Waiter.clearTablesBefore(a)}else{setField('#device-type-searchbox','input',device_type)}}else if(findByText('a','Device not found:')){Waiter.clearTable(a)}});Waiter.addTable(function(a){console.log('Third Table');if(!findByText('a','Device not found:')&&find('#device-type-searchbox').value!=device_type){if(!checkButtonClick(a,device_type,'a')){Waiter.clearTablesBefore(a)}}else if(findByText('a','Device not found:')){Waiter.clearTable(a)}})}Waiter.addTable(function(a){var b=findByAttribute('input','ng-model','deviceData.imei');if(b){if(checkExist('div.selected')){Waiter.clearTable(a);if(b.value.length!=15){if(imei.length==15){setField(b,'input',imei)}else{setField(b,'input',imei+'0');var c=1;var d=setInterval(function(){if(findByAttribute('div','ng-if','isImeiInvalid()')){if(findByAttribute('div','ng-if','isImeiInvalid()').textContent=='Invalid'){setField(b,'input',imei+c.toString());c+=1}}else if(findByText('button','Continue')){clearInterval(d)}},500)}}}}})}Waiter.addTable(function(a){if(findByText('button','Continue')){if(!findByText('button','Continue').disabled){var b=findByAttribute('input','ng-model','deviceData.serial');var c=findByAttribute('input','ng-model','deviceData.imei');if(b.value==c.value||b.value==imei||b.value==imei.substring(0,14)){setField(b,'input','')}checkButtonClick(a,'Continue')}}});return RAN_WORKED}function createWorkOrderPage(){if(!Waiter.isEmpty()){Waiter.clearAllTables()}Waiter.addTable(function(a){console.log('Table Number:',a);if(!findByText('button','Create Work Order')){if(findByText('div.repair-info-title','Cracked Screen')){findByText('div.repair-info-title','Cracked Screen').click()}if(checkExist('div.warranty-reason > select')){find('div.warranty-reason > select').value=0;runAngularTrigger('div.warranty-reason > select','change')}checkButtonClick(a,'Out Of Warranty')}else{checkButtonClick(a,'Create Work Order')}});Waiter.addTable(function(a){console.log('Table Number:',a);if(findByText('button','Submit and Open Work Order')){if(checkExist('#customer-email')){if(find('#customer-email').value==''){setField('#customer-email','input','decline@customer.com')}Waiter.clearTable(a)}}});Waiter.addTable(function(a){console.log('Table Number:',a);checkButtonClick(a,'Submit and Open Work Order')});return RAN_WORKED}function workOrderPage(){if(!Waiter.isEmpty()){Waiter.clearAllTables()}Waiter.addSingle('ticket-button',function(){if(!checkExist('#ticket-button')&&checkExist('div.header-buttons')){var a=createTag(find('div.header-buttons'),'button','ticket-button','btn blue fastclickable','Generate Ticket','background-color: rgb(38, 156, 216); color: white;');a.addEventListener('click',function(){if(find('#ticket-button').innerText=='Generate Ticket'){if(find('span.only-name').innerText.includes('IPHONE')){iPhoneinProgress()}else if(find('span.only-name').innerText.includes('SAMSUNG')){inProgressSamsung()}}else if(find('#ticket-button').innerText=='Close Ticket'){if(find('span.only-name').innerText.includes('IPHONE')){iPhoneCloseTicket()}else if(find('span.only-name').innerText.includes('SAMSUNG')){samsungCloseTicket()}}})}if(!checkExist('#scan-open-button')&&checkExist('div.table-card')){createTagBefore(find('div.table-card'),1,'button','scan-open-button','btn btn-cancel fastclickable','Scan Parts','width: 100%');find('#scan-open-button').addEventListener('click',function(){if(findByAttribute('img.fastclickable','ng-click','openScanItemsModal()')){findByAttribute('img.fastclickable','ng-click','openScanItemsModal()').click()}})}if(checkExist('#ticket-button')&&checkExist('#scan-open-button')){Waiter.clearSingle('ticket-button')}},1000);var b=setInterval(function(){if(!checkExist('#scan-camera-button')&&findByText('h3.modal-title','VERIFY ITEM LABELS/SERIALS')&&findByAttribute('img.fastclickable','ng-click','openScanItemsModal()')&&checkExist('div.barcode-start')){createTagBefore(find('div.barcode-start'),1,'button','scan-camera-button','btn btn-cancel fastclickable','Open Scanner','width: 100%');find('#scan-camera-button').addEventListener('click',function(){if(findByText('button','Cannot Scan Label')){findByText('button','Cannot Scan Label').id='scan-label-button';find('#scan-label-button').click();if(!checkExist('#interactive')){createScanner()}}})}else if(checkExist('div.scan-sale-items-modal div.modal-row')&&!checkExist('#interactive')&&!checkExist('#scan-camera-button')){createTagAppend(find('div.scan-sale-items-modal div.modal-row'),'button','scan-camera-button','btn btn-cancel fastclickable','Open Scanner','width: 100%');find('#scan-camera-button').addEventListener('click',function(){if(!checkExist('#interactive')){createScanner()}})}if(checkExist('#interactive')&&checkExist('#scan-camera-button')){remove('#scan-camera-button')}},500)}function createScanner(){Waiter.addTable(function(d){if(checkExist('div.barcode-scan input')){find('div.barcode-scan input').id='barcode-scan-field';createTagAppend(findByAttribute('div','ng-if','!isAllInventoryScanned()'),'div','interactive','viewport');addHTML('#interactive','<video autoplay="true" preload="auto" src(unknown) muted="true" playsinline="true"></video>'+'<canvas class="drawingBuffer" width="640" height="480"');createTag(find('#interactive'),'button','stop-camera-button','btn btn-cancel fastclickable','Close Camera','width: 100%');find('#interactive').addEventListener('click',function(){Quagga.stop();remove('#interactive')})Waiter.clearTable(d);Quagga.init({inputStream:{name:"Live",type:"LiveStream",constraints:{width:640,height:480},numOfWorkers:8,locate:true,frequency:10,target:document.querySelector('#interactive.viewport')},decoder:{readers:["code_128_reader"]}},function(a){if(a){console.log(a);return}console.log("Initialization finished. Ready to start");Quagga.start()});console.log('Going to run On Detected');Quagga.onProcessed(function(b){var c=Quagga.canvas.ctx.overlay,drawingCanvas=Quagga.canvas.dom.overlay;if(b){if(b.boxes){c.clearRect(0,0,parseInt(drawingCanvas.getAttribute("width")),parseInt(drawingCanvas.getAttribute("height")));b.boxes.filter(function(a){return a!==b.box}).forEach(function(a){Quagga.ImageDebug.drawPath(a,{x:0,y:1},c,{color:"green",lineWidth:2})})}if(b.box){Quagga.ImageDebug.drawPath(b.box,{x:0,y:1},c,{color:"#00F",lineWidth:2})}if(b.codeResult&&b.codeResult.code){Quagga.ImageDebug.drawPath(b.line,{x:'x',y:'y'},c,{color:'red',lineWidth:3});console.log('Bardcode:',b.codeResult.code)}}})}})}var note_button='#paneled-side-bar > div > div.bar-buttons > button.btn.blue.fastclickable';function iPhoneinProgress(){createNote('Repair in Progress','Device is being repaired.');Waiter.addTable(function(a){checkButtonClick(a,'Create Repair Ticket')});Waiter.addTable(function(a){checkButtonClick(a,'Proceed')})}function iPhoneCloseTicket(){if(!Waiter.isEmpty()){Waiter.clearAllTables();console.log('Clear Table')}createNote('Quality Inspection','Device is repaired and is going through testing.');console.log('Setting Work Order to Quality Inspection');Waiter.addTable(function(a){console.log('Running');checkButtonClick(a,'Add','button.btn-confirm')});Waiter.addTable(function(a){checkButtonClick(a,'Test Complete')});Waiter.addTable(function(a){checkButtonClick(a,'Done')});Waiter.addTable(function(a){if(checkExist('div.toast-message')){sleep(250).then(()=>{Waiter.clearTable(a)})}});Waiter.addTable(function(a){if(checkExist('span.bg-quality-inspection')){createNote('Repaired - RFP','Device is repaired and ready to be returned to the customer.',1000);Waiter.clearTable(a)}});Waiter.addTable(function(a){checkButtonClick(a,'Add','button.btn-confirm')});Waiter.addTable(function(a){checkButtonClick(a,'Check Out','span.hover-text')});Waiter.addTable(function(a){if(checkButtonClick(a,'TRADE CREDIT')){Waiter.clearAllTables()}})}function inProgressSamsung(){if(!Waiter.isEmpty()){Waiter.clearAllTables()}Waiter.addTable(function(a){checkButtonClick(a,'Create GSPN Repair Ticket')});Waiter.addTable(function(a){checkButtonClick(a,'Create Repair Ticket')});Waiter.addTable(function(a){checkButtonClick(a,'Close','.modal-dialog button')});Waiter.addTable(function(a){createNote(a,'Repair in Progress','Device is bieng repaired.');Waiter.clearAllTables()})}function samsungCloseTicket(){if(!Waiter.isEmpty()){Waiter.clearAllTables()}createNote('Quality Inspection','Device is reapired and going through testing.');Waiter.addTable(function(a){checkButtonClick(a,'Add','button.btn-confirm')});Waiter.addTable(function(a){checkButtonClick(a,'Test Complete')});Waiter.addTable(function(a){checkButtonClick(a,'Done')});Waiter.addTable(function(a){if(checkExist('div.toast-message')){sleep(250).then(()=>{Waiter.clearTable(a)})}});Waiter.addTable(function(a){if(checkExist('span.bg-quality-inspection')){find(note_button).click();var b=findByAttribute('select','ng-model','selectedOptions.gspn_defect_category_type_id');var c=findByAttribute('select','ng-model','selectedOptions.gspn_defect_code_id');var d=findByAttribute('select','ng-model','selectedOptions.gspn_repair_code_id');b.id='selector-1';c.id='selector-2';d.id='selector-3';b.value=8;runAngularTrigger('#selector-1','click');c.value=2;runAngularTrigger('#selector-2','click');d.value=3;runAngularTrigger('#selector-3','click');find(note_button).click();createNote('Repaired - RFP','Device is repaired and ready to be returned to the customer.',1000);Waiter.clearTable(a)}});Waiter.addTable(function(a){checkButtonClick(a,'Add','button.btn-confirm')});Waiter.addTable(function(a){checkButtonClick(a,'Test Complete')});Waiter.addTable(function(a){checkButtonClick(a,'Done')});Waiter.addTable(function(a){checkButtonClick(a,'Check Out','span.hover-text')});Waiter.addTable(function(a){if(checkButtonClick(a,'TRADE CREDIT')){Waiter.clearAllTables()}})}function createNote(a,b,c){find(note_button).click();sleep(sleep_time+250).then(()=>{if(!checkExist('#paneled-side-bar.closed')){var d=findAll('div.extra-actions > select > option');for(var i=0;i<d.length;i++){if(d[i].innerText==a){find('select.editor-add-in').value=i;break}}}find('.note-placeholder').style='display: none;';find('.note-editable').innerHTML=b;setField('.note-editable','input',b);find('select.editor-add-in').click();runAngularTrigger('div.extra-actions > select','change');if(find('#private').checked){find('#private').click()}sleep(sleep_time+250).then(()=>{findByText('button','Create Note').click()});sleep(sleep_time+350).then(()=>{find(note_button).click()})});return sleep_time+600}function checkButtonClick(a,b,c){console.log('Table Number:',a);console.log('Text:',b);console.log('Selector:',selector);var d=findByText(selector,b);if(d){if(!d.disabled){d.click();sleep(250).then(()=>{Waiter.clearTable(a)});return true}}return false}var Waiter={single_list:[],waiting_list:[],table_list:[],addSingle:function(a,b,c){this.single_list[a]=setInterval(function(){b()},check_time)},clearSingle:function(a){if(this.single_list[a]!=null){clearInterval(this.single_list[a])}},clearAllSingles:function(){for(var a in this.single_list){clearInterval(this.single_list[a])}},addTable:function(a,b,c){var d=this.waiting_list.length;this.table_list.push(false);this.waiting_list.push(setInterval(Waiter.checkTable,check_time,d,a,clearCondition));return this.waiting_list.length-1},checkTable:function(a,b,c){if(c==false){if(a>0){if(Waiter.table_list[a-1]){b(a)}}else{console.log('Waiter, Clear: False, Table Number:',a,'Order Check:',b);b(a)}}else if(c.typeof=='function'){if(!c()){if(a>0){if(Waiter.table_list[a-1]){b(a)}}else{b(a)}}else{Waiter.clearAllTables()}}},clearTable:function(a){if(a<Waiter.table_list.length&&a<Waiter.waiting_list.length){Waiter.table_list[a]=true;clearInterval(Waiter.waiting_list[a])}},clearTablesBefore:function(a){for(var i=0;i<=a;i++){this.clearTable(i)}},tableClearBefore:function(a){for(var i=0;i<=a;i++){if(!Waiter.table_list[i]){return false}}return true},clearAllTables:function(){console.log('-----Clear All Tables-----');console.log('Amount of Tables:',Waiter.amountOfTables());for(var i=0;i<Waiter.waiting_list.length;i++){clearInterval(Waiter.waiting_list[i])}Waiter.waiting_list=[];Waiter.table_list=[]},amountOfTables:function(){return Waiter.waiting_list.length},isEmpty:function(){if(Waiter.amountOfTables()>0){return false}return true}}function inArray(a,b){for(var i=0;i<b.length;i++){if(a.includes(b[i])){return i}}return-1}function replaceClass(a,b,c){if(a.className.includes(b)){var d=a.className;a.className=d.replaceAll(b,c)}}function getSelectorForElement(a){let path;while(a){let subSelector=a.localName;if(!subSelector){break}subSelector=subSelector.toLowerCase();var b=a.parentElement;if(b){var c=b.children;if(c.lenght>1){let nameCount=0;var d=[...sameTagSiblings].findIndex((child)=>{if(a.localName===child.localName){nameCount++}return child===elem})+1;if(d>1&&nameCount>1){subSelector+=':nth-child('+d+')'}}}path=subSelector+(path?'>'+path:'');a=b}}
