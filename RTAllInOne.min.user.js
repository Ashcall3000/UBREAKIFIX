// ==UserScript==
// @name         RT All In One
// @namespace    http://tampermonkey.net/
// @version      1.1.1
// @description  Makes the UBIF RT experience more automated so that you can spend more time doing the repair and less on the paperwork.
// @author       Christopher Sullivan
// @include      https://portal.ubif.net/*
// @require      https://github.com/Ashcall3000/UBREAKIFIX/raw/master/SearchElements.js
// @require      https://github.com/serratus/quaggaJS/raw/master/dist/quagga.min.js
// @downloadURL  https://github.com/Ashcall3000/UBREAKIFIX/raw/master/RTAllInOne.min.user.js
// @updateURL    https://github.com/Ashcall3000/UBREAKIFIX/raw/master/RTAllInOne.min.user.js
// @run-at document-idle
// @grant        none
// ==/UserScript==
var RAN_WORKED=1,RAN_FAILED=-1,RAN_WAITING=0,lead_page_ran=RAN_WAITING,select_device_ran=RAN_WAITING,create_workorder_ran=RAN_WAITING,workorder_ran=RAN_WAITING;setInterval(function(){checkURL("https://portal.ubif.net/store-ops/timeclock")&&!checkExist("#update-button")&&(createTagAppend(find(".portal-actions"),"button","update-button","btn blue left-icon fastclickable","Update Script","background-color: rgb(38, 156, 216); color: white;"),createTag(find("#update-button"),"span","","fa fa-fw fa-refresh"),find("#update-button").addEventListener("click",function(){window.open("https://github.com/Ashcall3000/UBREAKIFIX/raw/master/RTAllInOne.user.js")})),checkURL("https://portal.ubif.net/pos/aqleads/edit/")?lead_page_ran==RAN_WAITING&&(lead_page_ran=leadPage()):lead_page_ran=RAN_WAITING,checkURL("https://portal.ubif.net/pos/device-type-select/lead/")?select_device_ran==RAN_WAITING&&(select_device_ran=selectDevicePage()):select_device_ran=RAN_WAITING,checkURL("https://portal.ubif.net/pos/device-repair-select/")?create_workorder_ran==RAN_WAITING&&(create_workorder_ran=createWorkOrderPage(),imei="",device_type="",part_button=null):create_workorder_ran=RAN_WAITING,checkURL("https://portal.ubif.net/pos/checkout-new/")?(workorder_ran==RAN_WAITING&&(workOrderPage(),workorder_ran=RAN_WORKED),checkExist("#ticket-button")&&checkExist("span.bg-repair-in-progress")&&"Generate Ticket"==find("#ticket-button").innerText&&(find("#ticket-button").innerText="Close Ticket")):(Waiter.clearSingle("ticket-button"),workorder_ran=RAN_WAITING)},500);var iphone_list=["iPhone 12","iPhone 12 Pro","iPhone 12 Mini","iPhone 12 Pro Max","iPhone SE (2nd Gen)","iPhone 11","iPhone 11 Pro","iPhone 11 Pro Max","iPhone XS Max","iPhone XS","iPhone XR","iPhone X","iPhone 8","iPhone 8 Plus","iPhone 7","iPhone 7 Plus","iPhone 6S","iPhone 6S Plus","iPhone 6","iPhone 6 Plus"],samsung_list=["Samsung Galaxy Note 20","Samsung Galaxy Note 20 Ultra","Samsung Galaxy Note 10","Samsung Galaxy Note 10 Plus","Samsung Galaxy Note 9","Samsung Galaxy Note 8","Samsung Galaxy S20","Samsung Galaxy S20 FE","Samsung Galaxy S20 Ultra","Samsung Galaxy S20 Plus","Samsung Galaxy S20 5G","Samsung Galaxy S10 Plus","Samsung Galaxy S10","Samsung Galaxy S10e","Samsung Galaxy S10 Lite","Samsung Galaxy S10 5G","Samsung Galaxy S9","Samsung Galaxy S9 Plus","Samsung Galaxy S8","Samsung Galaxy S8 Plus","Samsung Galaxy S7","Samsung Galaxy S7 Edge","Samsung Galaxy A71","Samsung Galaxy A70","Samsung Galaxy A51","Samsung Galaxy A50","Samsung Galaxy A21","Samsung Galaxy A20","Samsung Galaxy A11","Samsung Galaxy A10","Samsung Galaxy A10e"],part_button=null,imei="",device_type="";function leadPage(){var e=setInterval(function(){findByText("span","Dismiss")&&(findByText("span","Dismiss").click(),clearInterval(e)),checkExist("#mobile-table")&&clearInterval(e)},250);return checkExist("#mobile-table")||findByText("span","Dismiss")||!checkExist("div.table-hold")?RAN_WAITING:(find("div.table-hold").setAttribute("hidden",""),find("div.table-hold").id="old-table",createLeadTable(),updateLeadTable(),RAN_WORKED)}function createLeadTable(){var e=find("sale-item-list"),t=createTag(e,"div","mobile-table","table-hold"),a=createTag(t,"table","","table portal-table flatTable table-stripped table-responsive"),n=createTag(a,"tr","","header-row"),i=createTag(n,"th","","center-data");createTag(i,"div","","","Item"),n=createTagAppend(a,"tr","",""),i=createTag(n,"td","","center-data"),createTag(i,"span","item-data",""),n=createTagAppend(a,"tr","","header-row"),i=createTag(n,"th","","center-data"),createTag(i,"div","","","SKU"),n=createTagAppend(a,"tr","",""),i=createTag(n,"td","","center-data"),createTag(i,"span","sku-data",""),n=createTagAppend(a,"tr","","header-row"),i=createTag(n,"th","","center-data"),createTag(i,"div","","","Serial"),n=createTagAppend(a,"tr","",""),i=createTag(n,"td","","center-data"),createTag(i,"span","serial-data",""),n=createTagAppend(a,"tr","","header-row"),i=createTag(n,"th","","center-data"),createTag(i,"div","","","Available"),n=createTagAppend(a,"tr","",""),i=createTag(n,"td","","center-data"),createTag(i,"span","available-data",""),n=createTagAppend(a,"tr","","header-row"),i=createTag(n,"th","","center-data"),createTag(i,"div","","","Remove Part"),n=createTagAppend(a,"tr","",""),createTag(n,"td","remove-part-td","center-data")}function updateLeadTable(){checkExist("div.action-buttons")?null===part_button&&(console.log("running"),part_button=find("div.action-buttons"),find("#remove-part-td").append(part_button),find("button",part_button).append(document.createTextNode("Remove Part"))):part_button=null,findByText("div.device-detail","IMEI")&&(imei=find("div.details",findByText("div.device-detail","IMEI")).innerText);var e=findByAttribute("td","ng-if","isLeadReserveOrNoReserve() || isReturn()","","",find("#old-table"));null!=e&&(e=e.innerText,find("#sku-data").innerText=e);var t=findSibling("label","div.details","Device").textContent,a=findByAttribute("td","ng-click","editSaleItem(saleItem, true)","","",find("#old-table"));null!=a&&(a=a.innerText,device_type=""==t?getDeviceName(a):t,find("#item-data").innerText=a);var n=findByAttribute("td","ng-if","!isSaleItemService(saleItem) && hasSaleItemLabel(saleItem)","","",find("#old-table"));n&&(n=n.innerText.substring(6),find("#serial-data").innerText=n);var i=findByAttribute("span","ng-if","!saleItem.inventory.store_item.item.is_service","","",find("#old-table"));null!=i&&(i=i.innerText),checkExist("#mobile-table")&&(find("#item-data").innerText=a||"Error",find("#sku-data").innerText=e||"Error",i?find("#available-data").innerText=i:find("#available-data").innerTExt="Error")}function getDeviceName(e){if(e.includes("Samsung")){if(-1!=(t=inArray(e,samsung_list)))return samsung_list[t]}else if(e.includes("iPhone")){var t;if(-1!=(t=inArray(e,iphone_list)))return iphone_list[t]}return""}function selectDevicePage(){return findByText("button","Continue")||(checkExist("div.selected")||""==device_type||(setField("#device-type-searchbox","input",device_type.trim()+" Repair"),Waiter.addTable(function(e){console.log("First Table"),checkExist("div.selected")?Waiter.clearTablesBefore(2):findByText("a","Device not found:")||""==find("#device-type-searchbox").value?findByText("a","Device not found:")&&Waiter.clearTable(e):checkButtonClick(e,device_type.trim()+" Repair","a")?Waiter.clearTablesBefore(2):setField("#device-type-searchbox","input",device_type.replace(" Plus","+"))}),Waiter.addTable(function(e){console.log("Second Table"),findByText("a","Device not found:")||find("#device-type-searchbox").value==device_type.replace(" Plus","+")?findByText("a","Device not found:")&&Waiter.clearTable(e):checkButtonClick(e,device_type.replace(" Plus","+"),"a")?Waiter.clearTablesBefore(e):setField("#device-type-searchbox","input",device_type)}),Waiter.addTable(function(e){console.log("Third Table"),findByText("a","Device not found:")||find("#device-type-searchbox").value==device_type?findByText("a","Device not found:")&&Waiter.clearTable(e):checkButtonClick(e,device_type,"a")||Waiter.clearTablesBefore(e)})),Waiter.addTable(function(e){var t=findByAttribute("input","ng-model","deviceData.imei");if(t&&checkExist("div.selected")&&(Waiter.clearTable(e),15!=t.value.length))if(15==imei.length)setField(t,"input",imei);else{setField(t,"input",imei+"0");var a=1,n=setInterval(function(){findByAttribute("div","ng-if","isImeiInvalid()")?"Invalid"==findByAttribute("div","ng-if","isImeiInvalid()").textContent&&(setField(t,"input",imei+a.toString()),a+=1):findByText("button","Continue")&&clearInterval(n)},500)}})),Waiter.addTable(function(e){if(findByText("button","Continue")&&!findByText("button","Continue").disabled){var t=findByAttribute("input","ng-model","deviceData.serial"),a=findByAttribute("input","ng-model","deviceData.imei");t.value!=a.value&&t.value!=imei&&t.value!=imei.substring(0,14)||setField(t,"input",""),checkButtonClick(e,"Continue")}}),RAN_WORKED}function createWorkOrderPage(){return Waiter.isEmpty()||Waiter.clearAllTables(),Waiter.addTable(function(e){console.log("Table Number:",e),findByText("button","Create Work Order")?checkButtonClick(e,"Create Work Order"):(findByText("div.repair-info-title","Cracked Screen")&&findByText("div.repair-info-title","Cracked Screen").click(),checkExist("div.warranty-reason > select")&&(find("div.warranty-reason > select").value=0,runAngularTrigger("div.warranty-reason > select","change")),checkButtonClick(e,"Out Of Warranty"))}),Waiter.addTable(function(e){console.log("Table Number:",e),findByText("button","Submit and Open Work Order")&&checkExist("#customer-email")&&(""==find("#customer-email").value&&setField("#customer-email","input","decline@customer.com"),Waiter.clearTable(e))}),Waiter.addTable(function(e){console.log("Table Number:",e),checkButtonClick(e,"Submit and Open Work Order")}),RAN_WORKED}function workOrderPage(){Waiter.isEmpty()||Waiter.clearAllTables(),Waiter.addSingle("ticket-button",function(){!checkExist("#ticket-button")&&checkExist("div.header-buttons")&&createTag(find("div.header-buttons"),"button","ticket-button","btn blue fastclickable","Generate Ticket","background-color: rgb(38, 156, 216); color: white;").addEventListener("click",function(){"Generate Ticket"==find("#ticket-button").innerText?find("span.only-name").innerText.includes("IPHONE")?iPhoneinProgress():find("span.only-name").innerText.includes("SAMSUNG")&&inProgressSamsung():"Close Ticket"==find("#ticket-button").innerText&&(find("span.only-name").innerText.includes("IPHONE")?iPhoneCloseTicket():find("span.only-name").innerText.includes("SAMSUNG")&&samsungCloseTicket())});!checkExist("#scan-open-button")&&checkExist("div.table-card")&&(createTagBefore(find("div.table-card"),1,"button","scan-open-button","btn btn-cancel fastclickable","Scan Parts","width: 100%"),find("#scan-open-button").addEventListener("click",function(){findByAttribute("img.fastclickable","ng-click","openScanItemsModal()")&&findByAttribute("img.fastclickable","ng-click","openScanItemsModal()").click()})),checkExist("#ticket-button")&&checkExist("#scan-open-button")&&Waiter.clearSingle("ticket-button")},1e3);setInterval(function(){!checkExist("#scan-camera-button")&&findByText("h3.modal-title","VERIFY ITEM LABELS/SERIALS")&&findByAttribute("img.fastclickable","ng-click","openScanItemsModal()")&&checkExist("div.barcode-start")?(createTagBefore(find("div.barcode-start"),1,"button","scan-camera-button","btn btn-cancel fastclickable","Open Scanner","width: 100%"),find("#scan-camera-button").addEventListener("click",function(){findByText("button","Cannot Scan Label")&&(findByText("button","Cannot Scan Label").id="scan-label-button",find("#scan-label-button").click(),checkExist("#interactive")||createScanner())})):!checkExist("div.scan-sale-items-modal div.modal-row")||checkExist("#interactive")||checkExist("#scan-camera-button")||(createTagAppend(find("div.scan-sale-items-modal div.modal-row"),"button","scan-camera-button","btn btn-cancel fastclickable","Open Scanner","width: 100%"),find("#scan-camera-button").addEventListener("click",function(){checkExist("#interactive")||createScanner()})),checkExist("#interactive")&&checkExist("#scan-camera-button")&&remove("#scan-camera-button")},500)}function createScanner(){Waiter.addTable(function(e){checkExist("div.barcode-scan input")&&(find("div.barcode-scan input").id="barcode-scan-field",createTagAppend(findByAttribute("div","ng-if","!isAllInventoryScanned()"),"div","interactive","viewport"),addHTML("#interactive",'<video autoplay="true" preload="auto" src(unknown) muted="true" playsinline="true"></video><canvas class="drawingBuffer" width="640" height="480"'),createTag(find("#interactive"),"button","stop-camera-button","btn btn-cancel fastclickable","Close Camera","width: 100%"),find("#interactive").addEventListener("click",function(){Quagga.stop(),remove("#interactive")}),Waiter.clearTable(e),Quagga.init({inputStream:{name:"Live",type:"LiveStream",constraints:{width:640,height:480},numOfWorkers:8,locate:!0,frequency:10,target:document.querySelector("#interactive.viewport")},decoder:{readers:["code_128_reader"]}},function(e){e?console.log(e):(console.log("Initialization finished. Ready to start"),Quagga.start())}),console.log("Going to run On Detected"),Quagga.onProcessed(function(e){var t=Quagga.canvas.ctx.overlay,a=Quagga.canvas.dom.overlay;e&&(e.boxes&&(t.clearRect(0,0,parseInt(a.getAttribute("width")),parseInt(a.getAttribute("height"))),e.boxes.filter(function(t){return t!==e.box}).forEach(function(e){Quagga.ImageDebug.drawPath(e,{x:0,y:1},t,{color:"green",lineWidth:2})})),e.box&&Quagga.ImageDebug.drawPath(e.box,{x:0,y:1},t,{color:"#00F",lineWidth:2}),e.codeResult&&e.codeResult.code&&(Quagga.ImageDebug.drawPath(e.line,{x:"x",y:"y"},t,{color:"red",lineWidth:3}),console.log("Bardcode:",e.codeResult.code)))}))})}var note_button="#paneled-side-bar > div > div.bar-buttons > button.btn.blue.fastclickable";function iPhoneinProgress(){createNote("Repair in Progress","Device is being repaired."),Waiter.addTable(function(e){checkButtonClick(e,"Create Repair Ticket")}),Waiter.addTable(function(e){checkButtonClick(e,"Proceed")})}function iPhoneCloseTicket(){Waiter.isEmpty()||(Waiter.clearAllTables(),console.log("Clear Table")),createNote("Quality Inspection","Device is repaired and is going through testing."),console.log("Setting Work Order to Quality Inspection"),Waiter.addTable(function(e){console.log("Running"),checkButtonClick(e,"Add","button.btn-confirm")}),Waiter.addTable(function(e){checkButtonClick(e,"Test Complete")}),Waiter.addTable(function(e){checkButtonClick(e,"Done")}),Waiter.addTable(function(e){checkExist("div.toast-message")&&sleep(250).then(()=>{Waiter.clearTable(e)})}),Waiter.addTable(function(e){checkExist("span.bg-quality-inspection")&&(createNote("Repaired - RFP","Device is repaired and ready to be returned to the customer.",1e3),Waiter.clearTable(e))}),Waiter.addTable(function(e){checkButtonClick(e,"Add","button.btn-confirm")}),Waiter.addTable(function(e){checkButtonClick(e,"Check Out","span.hover-text")}),Waiter.addTable(function(e){checkButtonClick(e,"TRADE CREDIT")&&Waiter.clearAllTables()})}function inProgressSamsung(){Waiter.isEmpty()||Waiter.clearAllTables(),Waiter.addTable(function(e){checkButtonClick(e,"Create GSPN Repair Ticket")}),Waiter.addTable(function(e){checkButtonClick(e,"Create Repair Ticket")}),Waiter.addTable(function(e){checkButtonClick(e,"Close",".modal-dialog button")}),Waiter.addTable(function(e){createNote(e,"Repair in Progress","Device is bieng repaired."),Waiter.clearAllTables()})}function samsungCloseTicket(){Waiter.isEmpty()||Waiter.clearAllTables(),createNote("Quality Inspection","Device is reapired and going through testing."),Waiter.addTable(function(e){checkButtonClick(e,"Add","button.btn-confirm")}),Waiter.addTable(function(e){checkButtonClick(e,"Test Complete")}),Waiter.addTable(function(e){checkButtonClick(e,"Done")}),Waiter.addTable(function(e){checkExist("div.toast-message")&&sleep(250).then(()=>{Waiter.clearTable(e)})}),Waiter.addTable(function(e){if(checkExist("span.bg-quality-inspection")){find(note_button).click();var t=findByAttribute("select","ng-model","selectedOptions.gspn_defect_category_type_id"),a=findByAttribute("select","ng-model","selectedOptions.gspn_defect_code_id"),n=findByAttribute("select","ng-model","selectedOptions.gspn_repair_code_id");t.id="selector-1",a.id="selector-2",n.id="selector-3",t.value=8,runAngularTrigger("#selector-1","click"),a.value=2,runAngularTrigger("#selector-2","click"),n.value=3,runAngularTrigger("#selector-3","click"),find(note_button).click(),createNote("Repaired - RFP","Device is repaired and ready to be returned to the customer.",1e3),Waiter.clearTable(e)}}),Waiter.addTable(function(e){checkButtonClick(e,"Add","button.btn-confirm")}),Waiter.addTable(function(e){checkButtonClick(e,"Test Complete")}),Waiter.addTable(function(e){checkButtonClick(e,"Done")}),Waiter.addTable(function(e){checkButtonClick(e,"Check Out","span.hover-text")}),Waiter.addTable(function(e){checkButtonClick(e,"TRADE CREDIT")&&Waiter.clearAllTables()})}function createNote(e,t,a=0){return find(note_button).click(),sleep(a+250).then(()=>{if(!checkExist("#paneled-side-bar.closed"))for(var n=findAll("div.extra-actions > select > option"),i=0;i<n.length;i++)if(n[i].innerText==e){find("select.editor-add-in").value=i;break}find(".note-placeholder").style="display: none;",find(".note-editable").innerHTML=t,setField(".note-editable","input",t),find("select.editor-add-in").click(),runAngularTrigger("div.extra-actions > select","change"),find("#private").checked&&find("#private").click(),sleep(a+250).then(()=>{findByText("button","Create Note").click()}),sleep(a+350).then(()=>{find(note_button).click()})}),a+600}function checkButtonClick(e,t,a="button"){console.log("Table Number:",e),console.log("Text:",t),console.log("Selector:",a);var n=findByText(a,t);return!(!n||n.disabled)&&(n.click(),sleep(250).then(()=>{Waiter.clearTable(e)}),!0)}var Waiter={single_list:[],waiting_list:[],table_list:[],addSingle:function(e,t,a=500){this.single_list[e]=setInterval(function(){t()},a)},clearSingle:function(e){null!=this.single_list[e]&&clearInterval(this.single_list[e])},clearAllSingles:function(){for(var e in this.single_list)clearInterval(this.single_list[e])},addTable:function(e,t=1e3,a=!1){var n=this.waiting_list.length;return this.table_list.push(!1),this.waiting_list.push(setInterval(Waiter.checkTable,t,n,e,a)),this.waiting_list.length-1},checkTable:function(e,t,a){0==a?e>0?Waiter.table_list[e-1]&&t(e):(console.log("Waiter, Clear: False, Table Number:",e,"Order Check:",t),t(e)):"function"==a.typeof&&(a()?Waiter.clearAllTables():e>0?Waiter.table_list[e-1]&&t(e):t(e))},clearTable:function(e){e<Waiter.table_list.length&&e<Waiter.waiting_list.length&&(Waiter.table_list[e]=!0,clearInterval(Waiter.waiting_list[e]))},clearTablesBefore:function(e){for(var t=0;t<=e;t++)this.clearTable(t)},tableClearBefore:function(e){for(var t=0;t<=e;t++)if(!Waiter.table_list[t])return!1;return!0},clearAllTables:function(){console.log("-----Clear All Tables-----"),console.log("Amount of Tables:",Waiter.amountOfTables());for(var e=0;e<Waiter.waiting_list.length;e++)clearInterval(Waiter.waiting_list[e]);Waiter.waiting_list=[],Waiter.table_list=[]},amountOfTables:function(){return Waiter.waiting_list.length},isEmpty:function(){return!(Waiter.amountOfTables()>0)}};function inArray(e,t){for(var a=0;a<t.length;a++)if(e.includes(t[a]))return a;return-1}function replaceClass(e,t,a){if(e.className.includes(t)){var n=e.className;e.className=n.replaceAll(t,a)}}function getSelectorForElement(e){let t;for(;e;){let r=e.localName;if(!r)break;r=r.toLowerCase();var a=e.parentElement;if(a){var n=a.children;if(n.lenght>1){let t=0;var i=[...n].findIndex(a=>(e.localName===a.localName&&t++,a===elem))+1;i>1&&t>1&&(r+=":nth-child("+i+")")}}t=r+(t?">"+t:""),e=a}}
